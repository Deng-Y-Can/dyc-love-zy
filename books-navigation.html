<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ä¹¦ç±é˜…è¯»å™¨ï¼ˆæ”¯æŒPDFå’ŒTXTï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* å·¦ä¾§ç›®å½•æ  */
        .sidebar {
            width: 300px;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 15px;
        }

        .sidebar h2 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #333;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }

        .search-container {
            margin-bottom: 15px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 8px 30px 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
        }

        .search-icon {
            position: absolute;
            right: 10px;
            top: 10px;
            color: #999;
        }

        .search-results {
            margin-top: 10px;
            padding: 5px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }

        .search-result-item {
            padding: 5px;
            cursor: pointer;
            border-radius: 3px;
        }

        .search-result-item:hover {
            background-color: #e9ecef;
        }

        .directory-tree {
            list-style: none;
        }

        .tree-item {
            margin: 5px 0;
        }

        .item-wrapper {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .item-wrapper:hover {
            background-color: #e9ecef;
        }

        .folder-icon, .pdf-icon, .txt-icon {
            margin-right: 8px;
            font-size: 14px;
        }

        .folder-icon {
            color: #ffc107;
        }

        .pdf-icon {
            color: #dc3545;
        }

        .txt-icon {
            color: #198754;
        }

        .item-name {
            flex: 1;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .toggle-icon {
            font-size: 12px;
            color: #666;
            transition: transform 0.2s;
        }

        .subtree {
            margin-left: 20px;
            list-style: none;
            display: none; /* é»˜è®¤æŠ˜å  */
        }

        .subtree.expanded {
            display: block; /* å±•å¼€çŠ¶æ€ */
        }

        /* å³ä¾§å†…å®¹åŒº */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .controls {
            padding: 15px;
            background-color: #f1f3f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background-color: #e9ecef;
        }

        #pageInfo {
            color: #495057;
        }

        select {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .page-jump {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .page-input {
            width: 60px;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .pdf-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .pdf-background {
            position: absolute;
            width: 100%;
            z-index: 1;
        }

        .pdf-canvas {
            position: relative;
            z-index: 2;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .txt-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .txt-content {
            background-color: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-family: monospace;
            white-space: pre-wrap;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
        }

        .no-selection {
            color: #6c757d;
            font-style: italic;
            margin-top: 20px;
        }

        .error-message {
            color: #dc3545;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- å·¦ä¾§ç›®å½•æ  -->
    <div class="sidebar">
        <h2>æ–‡æ¡£ç›®å½•</h2>
        
        <!-- æœç´¢æ¡† -->
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹...">
            <span class="search-icon">ğŸ”</span>
            <div class="search-results" id="searchResults"></div>
        </div>
        
        <!-- ç›®å½•æ ‘ -->
        <ul class="directory-tree" id="directoryTree">
            <li class="loading">åŠ è½½ç›®å½•ä¸­...</li>
        </ul>
    </div>

    <!-- å³ä¾§å†…å®¹åŒº -->
    <div class="content">
        <div class="controls">
            <button id="prevPage">ä¸Šä¸€é¡µ</button>
            <button id="nextPage">ä¸‹ä¸€é¡µ</button>
            
            <!-- é¡µç è·³è½¬ -->
            <div class="page-jump">
                <input type="number" id="pageInput" class="page-input" min="1" placeholder="é¡µç ">
                <button id="jumpToPage">è·³è½¬</button>
            </div>
            
            <span id="pageInfo">é¡µç : 1 / 0</span>
            <select id="bgColor">
                <option value="#ffffff">ç™½è‰²</option>
                <option value="#f5f5f5">æµ…ç°</option>
                <option value="#e8f4fd">æ·¡è“</option>
                <option value="#fff8e1">æµ…é»„</option>
                <option value="#2c3e50">æ·±è‰²æ¨¡å¼</option>
            </select>
        </div>
        
        <!-- PDFå®¹å™¨ -->
        <div class="pdf-container" id="pdfContainer">
            <div class="no-selection">è¯·ä»å·¦ä¾§åŒå‡»PDFæˆ–TXTæ–‡ä»¶æ‰“å¼€</div>
        </div>
        
        <!-- TXTå®¹å™¨ -->
        <div class="txt-container" id="txtContainer" style="display: none;">
            <div class="txt-content" id="txtContent"></div>
        </div>
    </div>

    <script>
        // PDF.js é…ç½®
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        // å…¨å±€å˜é‡
        let pdfDoc = null;
        let currentPage = 1;
        let pageRendering = false;
        let currentFilePath = '';
        let currentFileType = ''; // 'pdf' æˆ– 'txt'
        let directoryData = null; // å­˜å‚¨å®Œæ•´ç›®å½•æ•°æ®ç”¨äºæœç´¢
        
        const pdfContainer = document.getElementById('pdfContainer');
        const txtContainer = document.getElementById('txtContainer');
        const txtContent = document.getElementById('txtContent');
        const directoryTree = document.getElementById('directoryTree');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');

        // åˆå§‹åŒ–ï¼šä»bookroute.jsonåŠ è½½ç›®å½•ç»“æ„
        async function initDirectoryTree() {
            try {
                // åŠ è½½åŒçº§ç›®å½•ä¸‹çš„bookroute.json
                const response = await fetch('bookroute.json');
                if (!response.ok) throw new Error(`åŠ è½½å¤±è´¥: ${response.statusText}`);
                
                directoryData = await response.json();
                directoryTree.innerHTML = ''; // æ¸…ç©ºåŠ è½½æç¤º
                buildDirectoryTree(directoryData, directoryTree); // ç”Ÿæˆç›®å½•æ ‘
                
                // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
                initSearch();
            } catch (error) {
                directoryTree.innerHTML = `<li class="error-message">ç›®å½•åŠ è½½å¤±è´¥: ${error.message}</li>`;
                console.error('ç›®å½•åŠ è½½é”™è¯¯:', error);
            }
        }

        // é€’å½’ç”Ÿæˆç›®å½•æ ‘HTML
        function buildDirectoryTree(node, parentElement) {
            // å¿½ç•¥éæ–‡ä»¶å¤¹ã€éPDFå’ŒéTXTæ–‡ä»¶
            if (node.Type === "File" && 
                !node.Name.toLowerCase().endsWith('.pdf') && 
                !node.Name.toLowerCase().endsWith('.txt')) {
                return;
            }

            const li = document.createElement('li');
            li.className = 'tree-item';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'item-wrapper';
            wrapper.dataset.type = node.Type;
            wrapper.dataset.relativePath = getRelativePath(node.Path); // å­˜å‚¨ç›¸å¯¹äºbookçš„è·¯å¾„

            // æ·»åŠ å›¾æ ‡
            const icon = document.createElement('span');
            if (node.Type === 'Directory') {
                icon.className = 'folder-icon';
                icon.textContent = 'ğŸ“';
            } else if (node.Name.toLowerCase().endsWith('.pdf')) {
                icon.className = 'pdf-icon';
                icon.textContent = 'ğŸ“„';
            } else {
                icon.className = 'txt-icon';
                icon.textContent = 'ğŸ“';
            }
            wrapper.appendChild(icon);

            // æ·»åŠ åç§°
            const nameSpan = document.createElement('span');
            nameSpan.className = 'item-name';
            nameSpan.textContent = node.Name;
            wrapper.appendChild(nameSpan);

            // æ–‡ä»¶å¤¹ï¼šæ·»åŠ å±•å¼€/æŠ˜å åŠŸèƒ½
            if (node.Type === 'Directory') {
                const toggle = document.createElement('span');
                toggle.className = 'toggle-icon';
                toggle.textContent = 'â–¶';
                wrapper.appendChild(toggle);
                
                // ç‚¹å‡»å±•å¼€/æŠ˜å 
                wrapper.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const subtree = li.querySelector('.subtree');
                    if (subtree) {
                        subtree.classList.toggle('expanded');
                        toggle.textContent = subtree.classList.contains('expanded') ? 'â–¼' : 'â–¶';
                    }
                });

                // ç”Ÿæˆå­ç›®å½•
                if (node.Children && node.Children.length > 0) {
                    const ul = document.createElement('ul');
                    ul.className = 'subtree';
                    li.appendChild(ul);
                    
                    // è¿‡æ»¤å­èŠ‚ç‚¹ï¼Œåªä¿ç•™æ–‡ä»¶å¤¹ã€PDFå’ŒTXTæ–‡ä»¶
                    const filteredChildren = node.Children.filter(child => 
                        child.Type === 'Directory' || 
                        child.Name.toLowerCase().endsWith('.pdf') ||
                        child.Name.toLowerCase().endsWith('.txt')
                    );
                    
                    filteredChildren.forEach(child => {
                        buildDirectoryTree(child, ul);
                    });
                }
            } else {
                // æ–‡ä»¶ï¼šåŒå‡»åŠ è½½
                wrapper.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    const relativePath = wrapper.dataset.relativePath;
                    const fileType = node.Name.toLowerCase().endsWith('.pdf') ? 'pdf' : 'txt';
                    loadFile(`book/${relativePath}`, fileType);
                });
            }

            li.appendChild(wrapper);
            parentElement.appendChild(li);
        }

        // ä»å®Œæ•´è·¯å¾„ä¸­æå–ç›¸å¯¹äºbookçš„è·¯å¾„
        function getRelativePath(fullPath) {
            const bookIndex = fullPath.toLowerCase().indexOf("book");
            if (bookIndex === -1) return fullPath;
            
            const relativePath = fullPath.substring(bookIndex + 4); // +4 è·³è¿‡"book"
            return relativePath.replace(/\\/g, "/").replace(/^\//, ""); // è½¬æ¢åæ–œæ å¹¶ç§»é™¤å¼€å¤´çš„æ–œæ 
        }

        // åŠ è½½æ–‡ä»¶ï¼ˆPDFæˆ–TXTï¼‰
        async function loadFile(url, fileType) {
            currentFilePath = url;
            currentFileType = fileType;
            
            // éšè—æ‰€æœ‰å®¹å™¨ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            pdfContainer.style.display = 'none';
            txtContainer.style.display = 'none';
            pdfContainer.innerHTML = '<div>åŠ è½½ä¸­...</div>';
            pdfContainer.style.display = 'flex';
            
            try {
                if (fileType === 'pdf') {
                    // åŠ è½½PDF
                    const loadingTask = pdfjsLib.getDocument(url);
                    pdfDoc = await loadingTask.promise;
                    currentPage = 1;
                    renderPage(currentPage); // æ¸²æŸ“ç¬¬ä¸€é¡µ
                    updatePageInfo(); // æ›´æ–°é¡µç æ˜¾ç¤º
                } else {
                    // åŠ è½½TXT
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`åŠ è½½å¤±è´¥: ${response.statusText}`);
                    
                    const text = await response.text();
                    txtContent.textContent = text;
                    
                    // æ˜¾ç¤ºTXTå®¹å™¨
                    pdfContainer.style.display = 'none';
                    txtContainer.style.display = 'block';
                }
            } catch (error) {
                pdfContainer.innerHTML = `<div class="error-message">æ–‡ä»¶åŠ è½½å¤±è´¥: ${error.message}</div>`;
                console.error('æ–‡ä»¶åŠ è½½é”™è¯¯:', error);
            }
        }

        // æ¸²æŸ“æŒ‡å®šé¡µç ï¼ˆPDFï¼‰
        async function renderPage(num) {
            if (pageRendering || !pdfDoc) return;
            pageRendering = true;

            try {
                const page = await pdfDoc.getPage(num);
                const scale = 1.2; // æ¸²æŸ“ç¼©æ”¾æ¯”ä¾‹
                const viewport = page.getViewport({ scale });

                // æ¸…ç©ºå®¹å™¨å¹¶åˆ›å»ºèƒŒæ™¯å±‚
                pdfContainer.innerHTML = '';
                const background = document.createElement('div');
                background.className = 'pdf-background';
                background.style.height = `${viewport.height}px`;
                background.style.width = `${viewport.width}px`;
                background.style.backgroundColor = document.getElementById('bgColor').value;
                pdfContainer.appendChild(background);

                // åˆ›å»ºCanvasæ¸²æŸ“PDF
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-canvas';
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                pdfContainer.appendChild(canvas);

                // æ¸²æŸ“é…ç½®
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };

                // æ‰§è¡Œæ¸²æŸ“
                await page.render(renderContext).promise;
                currentPage = num;
                updatePageInfo();
            } catch (error) {
                pdfContainer.innerHTML = `<div class="error-message">é¡µé¢æ¸²æŸ“å¤±è´¥: ${error.message}</div>`;
                console.error('é¡µé¢æ¸²æŸ“é”™è¯¯:', error);
            } finally {
                pageRendering = false;
            }
        }

        // æ›´æ–°é¡µç æ˜¾ç¤º
        function updatePageInfo() {
            document.getElementById('pageInfo').textContent = 
                currentFileType === 'pdf' 
                ? `é¡µç : ${currentPage} / ${pdfDoc ? pdfDoc.numPages : 0}`
                : 'TXTæ–‡ä»¶';
            
            // æ›´æ–°é¡µç è¾“å…¥æ¡†
            const pageInput = document.getElementById('pageInput');
            if (currentFileType === 'pdf' && pdfDoc) {
                pageInput.disabled = false;
                pageInput.max = pdfDoc.numPages;
            } else {
                pageInput.disabled = true;
                pageInput.value = '';
            }
        }

        // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
        function initSearch() {
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim().toLowerCase();
                if (query.length < 2) { // è‡³å°‘è¾“å…¥2ä¸ªå­—ç¬¦æ‰å¼€å§‹æœç´¢
                    searchResults.style.display = 'none';
                    return;
                }
                
                // æ‰§è¡Œæœç´¢
                const results = searchDirectory(directoryData, query);
                
                // æ˜¾ç¤ºæœç´¢ç»“æœ
                searchResults.innerHTML = '';
                if (results.length > 0) {
                    results.forEach(result => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-result-item';
                        resultItem.textContent = result.path;
                        resultItem.dataset.relativePath = result.relativePath;
                        resultItem.dataset.type = result.type;
                        
                        resultItem.addEventListener('click', () => {
                            searchInput.value = '';
                            searchResults.style.display = 'none';
                            
                            if (result.type === 'Directory') {
                                // å±•å¼€ç›®å½•
                                expandDirectoryByPath(result.relativePath);
                            } else {
                                // æ‰“å¼€æ–‡ä»¶
                                loadFile(`book/${result.relativePath}`, 
                                    result.name.toLowerCase().endsWith('.pdf') ? 'pdf' : 'txt');
                            }
                        });
                        
                        searchResults.appendChild(resultItem);
                    });
                    searchResults.style.display = 'block';
                } else {
                    searchResults.innerHTML = '<div class="search-result-item" style="color: #999;">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</div>';
                    searchResults.style.display = 'block';
                }
            });
            
            // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­æœç´¢ç»“æœ
            document.addEventListener('click', (e) => {
                if (!searchContainer.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
        }

        // æœç´¢ç›®å½•
        function searchDirectory(node, query) {
            const results = [];
            
            // æ£€æŸ¥å½“å‰èŠ‚ç‚¹æ˜¯å¦åŒ¹é…
            if (node.Name.toLowerCase().includes(query)) {
                results.push({
                    name: node.Name,
                    path: getDisplayPath(node),
                    relativePath: getRelativePath(node.Path),
                    type: node.Type
                });
            }
            
            // é€’å½’æœç´¢å­èŠ‚ç‚¹
            if (node.Children && node.Children.length > 0) {
                // è¿‡æ»¤å­èŠ‚ç‚¹ï¼Œåªæœç´¢æ–‡ä»¶å¤¹ã€PDFå’ŒTXTæ–‡ä»¶
                const filteredChildren = node.Children.filter(child => 
                    child.Type === 'Directory' || 
                    child.Name.toLowerCase().endsWith('.pdf') ||
                    child.Name.toLowerCase().endsWith('.txt')
                );
                
                filteredChildren.forEach(child => {
                    results.push(...searchDirectory(child, query));
                });
            }
            
            return results;
        }

        // è·å–ç”¨äºæ˜¾ç¤ºçš„å®Œæ•´è·¯å¾„
        function getDisplayPath(node) {
            let path = node.Name;
            let current = node;
            
            while (current.parent) {
                current = current.parent;
                path = `${current.Name}/${path}`;
            }
            
            return path;
        }

        // æ ¹æ®è·¯å¾„å±•å¼€ç›®å½•
        function expandDirectoryByPath(relativePath) {
            // å°†è·¯å¾„åˆ†å‰²ä¸ºéƒ¨åˆ†
            const pathParts = relativePath.split('/');
            let currentElement = directoryTree;
            
            // é€çº§æŸ¥æ‰¾å¹¶å±•å¼€ç›®å½•
            for (let i = 0; i < pathParts.length; i++) {
                const part = pathParts[i];
                let found = false;
                
                // æŸ¥æ‰¾åŒ¹é…çš„ç›®å½•é¡¹
                for (let j = 0; j < currentElement.children.length; j++) {
                    const child = currentElement.children[j];
                    const itemName = child.querySelector('.item-name').textContent;
                    
                    if (itemName === part) {
                        // å±•å¼€ç›®å½•
                        const subtree = child.querySelector('.subtree');
                        if (subtree) {
                            subtree.classList.add('expanded');
                            const toggleIcon = child.querySelector('.toggle-icon');
                            if (toggleIcon) toggleIcon.textContent = 'â–¼';
                        }
                        
                        currentElement = subtree;
                        found = true;
                        break;
                    }
                }
                
                if (!found) break;
            }
        }

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentFileType === 'pdf' && pdfDoc && currentPage > 1) {
                renderPage(currentPage - 1);
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (currentFileType === 'pdf' && pdfDoc && currentPage < pdfDoc.numPages) {
                renderPage(currentPage + 1);
            }
        });

        // è·³è½¬åˆ°æŒ‡å®šé¡µç 
        document.getElementById('jumpToPage').addEventListener('click', () => {
            if (currentFileType === 'pdf' && pdfDoc) {
                const pageInput = document.getElementById('pageInput');
                const pageNum = parseInt(pageInput.value);
                
                if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= pdfDoc.numPages) {
                    renderPage(pageNum);
                } else {
                    alert(`è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç  (1-${pdfDoc.numPages})`);
                }
            }
        });

        // æ”¯æŒæŒ‰å›è½¦é”®è·³è½¬é¡µç 
        document.getElementById('pageInput').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('jumpToPage').click();
            }
        });

        // èƒŒæ™¯è‰²åˆ‡æ¢
        document.getElementById('bgColor').addEventListener('change', () => {
            const bgColor = event.target.value;
            
            if (currentFileType === 'pdf') {
                const background = pdfContainer.querySelector('.pdf-background');
                if (background) background.style.backgroundColor = bgColor;
            } else if (currentFileType === 'txt') {
                txtContent.style.backgroundColor = bgColor;
            }
        });

        // åˆå§‹åŒ–ç›®å½•
        initDirectoryTree();
    </script>
</body>
</html>